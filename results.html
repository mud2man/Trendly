<!doctype html>
<html lang="en">
  <head>
    <title>Trendly</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="assets/main.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Bree+Serif|Pacifico" rel="stylesheet">

    <!-- Codebird -->
    <script type="text/javascript" src="assets/codebird.js"></script>
  </head>
  <body>

    <div class="container">
      <div class="row">
        <div class="col-lg-2 col-md-12">
          <div class='text-center title-small brand'>
            Trendly
          </div>
        </div>
        <div class='col-lg-10 col-md-12'>
          <br />
          <form action="results.html">
            <div class="input-group">
              <input type="text" class="form-control text-center" id="queryInput-results" name='q' placeholder="What would you like to know about?">
            </div>
          </form>
        </div>
      </div>
      <br />
      <div id='previous-queries' class='text-center' style='display: none;'>
        <span class='previous-queries-label'>Previous queries:</span>
      </div>
      <div id="results-loading" class='regular-font text-center'>
        <br />
        Analyzing...
        <br />
        <br />
        <div id="loader">

        </div>
      </div>
      <div id="twitter-connection-error" class='regular-font text-center' style="display: none;">
        <br />
        Something went wrong.
        <br />
        <br />
        <span style="font-size: 0.75em;">Our connection to Twitter experienced an unexpected error.<br />Please try again shortly.</span>
      </div>
      <div id="twitter-no-tweets-error" class='regular-font text-center' style="display: none;">
        <br />
        Hmmm, we can't find any tweets about that!
        <br />
        <br />
        <span style="font-size: 0.75em;">Please adjust your query and try again.</span>
      </div>
      <div id="results-content">
        <nav class="nav nav-pills nav-fill">
          <a id="sentiment-pill" class="nav-item nav-link active" href="#">Statistics</a>
          <a id="positive-pill" class="nav-item nav-link" href="#">Positive Tweets</a>
          <a id="negative-pill" class="nav-item nav-link" href="#">Negative Tweets</a>
          <a id="neutral-pill" class="nav-item nav-link" href="#">Neutral Tweets</a>
        </nav>
        <div id="sentiment" class="row">
          <div class="col-md-12">
            <div id='num-analyzed' class="regular-font text-center">
          
            </div>
          </div>
          <div class="col-md-1">
          </div>
          <div class="col-md-5">
            <canvas id="myChart" width="400" height="400"></canvas>
          </div>
          <div class="col-md-5">
            <canvas id="barChart" width="400" height="400"></canvas>
          </div>
          <div class="col-md-1">
          </div>
        </div>
        <div id="positive" class="row" style="display:none;">
          <div class="col-md-12">
            <div id='num-positive' class="regular-font text-center">
          
            </div>
          </div>
          <div class="col-md-3">
          </div>
          <div class="col-md-6">
            <div id='positive-tweets'>

            </div>
          </div>
          <div class="col-md-3">
          </div>
        </div>
        <div id="negative" class="row" style="display:none;">
          <div class="col-md-12">
            <div id='num-negative' class="regular-font text-center">
          
            </div>
          </div>
          <div class="col-md-3">
          </div>
          <div class="col-md-6">
            <div id='negative-tweets'>

            </div>
          </div>
          <div class="col-md-3">
          </div>
        </div>
        <div id="neutral" class="row" style="display:none;">
          <div class="col-md-12">
            <div id='num-neutral' class="regular-font text-center">
          
            </div>
          </div>
          <div class="col-md-3">
          </div>
          <div class="col-md-6">
            <div id='neutral-tweets'>

            </div>
          </div>
          <div class="col-md-3">
          </div>
        </div>
      </div>
    </div>

    



    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.2.1.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ" crossorigin="anonymous"></script>

    <!-- Twitter stuff -->
    <script sync src="https://platform.twitter.com/widgets.js"></script>

    <script sync src="assets/chart.min.js"></script>
    <script sync src="assets/results-pills.js"></script>
    <script sync src="assets/results-util.js"></script>
    <script sync src="assets/js.cookie.js"></script>


    <!-- More Codebird -->
    <script type="text/javascript">
      var commonwords = {
        "": 1,
        the: 1,
        of: 1,
        and: 1,
        to: 1,
        a: 1,
        in: 1,
        for: 1,
        is: 1,
        on: 1,
        that: 1,
        by: 1,
        this: 1,
        with: 1,
        i: 1,
        you: 1,
        it: 1,
        not: 1,
        or: 1,
        be: 1,
        are: 1,
        from: 1,
        at: 1,
        as: 1,
        your: 1,
        all: 1,
        have: 1,
        new: 1,
        more: 1,
        an: 1,
        was: 1,
        we: 1,
        will: 1,
        home: 1,
        can: 1,
        us: 1,
        about: 1,
        if: 1,
        page: 1,
        my: 1,
        has: 1,
        search: 1,
        free: 1,
        but: 1,
        our: 1,
        one: 1,
        other: 1,
        do: 1,
        no: 1,
        because: 1,
        rt: 1,
        co: 1,
        t: 1,
        https: 1,
        http: 1,
        he: 1,
        v: 1,
        trending: 1,
        his: 1,
        her: 1,
        they: 1,
        like: 1,
        how: 1,
        who: 1,
        what: 1,
        when: 1,
        where: 1,
        why: 1,
        just: 1,
        most: 1,
        only: 1,
        some: 1,
        every: 1,
        their: 1,
        been: 1,
        "don't": 1,
        him: 1
      }

      // https://www.sitepoint.com/url-parameters-jquery/
      $.urlParam = function(name){
        console.log("window.location.href:" + window.location.href);
        var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
        return results[1] || 0;
      }
      var raw_query = $.urlParam("q");
      var radius = $.urlParam("radius");
      radius = radius / 1600;
      var lon = $.urlParam("lon");
      var lat = $.urlParam("lat");
      var geocode_query = lat + "," + lon + "," + radius + "mi";
      console.log("raw_query:" + raw_query);
      console.log("radius:" + radius);
      console.log("lon:" + lon);
      console.log("lat:" + lat);
      console.log("geocode_query:" + geocode_query);
      
      //console.log("r:" + $.urlParam("r"));
      if (!(raw_query)) {
        window.location.href = '/index.html';
      }
      var query = decodeURIComponent(raw_query.replace(/\+/, " "));
      // https://stackoverflow.com/questions/154059/how-do-you-check-for-an-empty-string-in-javascript
      function isBlank(str) {
        return (!str || /^\s*$/.test(str));
      }
      if (isBlank(query)) {
        window.location.href = '/index.html';
      }
      $('#queryInput-results').val(query);

      var past_queries = Cookies.get('past_queries');
      console.log(past_queries);
      var queries;
      if (past_queries) {
        queries = JSON.parse(past_queries);
      } else {
        queries = [];
      }
      var fixed_queries = [];
      var is_first = true;
      for (var i = 0; i < queries.length; ++i) {
        if (queries[i][0] != raw_query) {
          fixed_queries.push(queries[i]);
          if (is_first) {
            is_first = false;
          } else {
            $('#previous-queries').append("<span class='previous-queries-label'>, </span>")
          }
          $('#previous-queries').append('<a href="results.html?q=' + queries[i][0] + '">' + queries[i][1] + '</a>');
        }
      }
      if (fixed_queries.length >= 5) {
        fixed_queries.pop();
      }
      if (fixed_queries.length > 0) {
        $('#previous-queries').fadeIn();
      }
      fixed_queries.unshift([raw_query, query]);
      console.log(fixed_queries);
      Cookies.set('past_queries', JSON.stringify(fixed_queries));

      
      var cb = new Codebird;
      cb.setConsumerKey("nDuDRuXVkv3N3GrJiTXm5cXtH", "nnqF5HGuyOURRe2fkcUZpVMTwdGS5xecfQIZvDr5GM2is8PsPr");

      var params = {
        q: query + ' -filter:retweets',
        //geocode: "40.808127,-73.965864,100mi",
        geocode: geocode_query,
        count: 100,
        lang: 'en',
        tweet_mode: 'extended',
        result_type: 'mixed'
      };
      console.log("params.q:" + params.q);
      cb.__call(
          "search_tweets",
          params,
          function (reply) {
            if (reply.httpstatus != 200) {
              // error
              $("#results-loading").fadeOut(function() {
                $("#twitter-connection-error").fadeIn();
              });
              return;
            } else if (reply["statuses"].length == 0) {
              $("#results-loading").fadeOut(function() {
                $("#twitter-no-tweets-error").fadeIn();
              });
              return;
            }
            var to_get = [];
            var sentiment_params = {};
            sentiment_params["documents"] = [];
            var word_frequencies = {}
            $('#num-analyzed').append(reply["statuses"].length + ' tweets analyzed.')
            reply["statuses"].forEach(function(e) {
              to_get.push({id: e["id_str"], user: e["user"]["screen_name"]});
              sentiment_params["documents"].push({id: e["id_str"], text: e["full_text"],
              language: "en" 
              });
              var words = e["full_text"].replace(/[.,\/!$%\^&\*"'@;:…{}=\-_`~()]/g," ").toLowerCase().split(" ");
              var querywords = query.replace(/[.,\/!$%\^&\*@;:"'…{}=\-_`~()]/g," ").toLowerCase().split(" ");
              words.forEach(function (w) {
                if (!(w in commonwords) && !($.inArray(w, querywords) > -1) && (w.length > 2)) {
                  if (!(w in word_frequencies)) {
                    word_frequencies[w] = 1;
                  } else {
                    word_frequencies[w] += 1;
                  }
                }
              });
            });
            var sortable_words = [];
            for (var w in word_frequencies) {
              sortable_words.push([w, word_frequencies[w]]);
            }
            sortable_words.sort(function(a, b) {
              return b[1] - a[1];
            });
            
            // Word frequencies
            var wordfreqdata = [];
            var wordfreqlabels = [];
            var colors = [];
            for (var i = 0; i < sortable_words.length && i < 10; ++i) {
              wordfreqdata.push(sortable_words[i][1]);
              wordfreqlabels.push(sortable_words[i][0]);
              var red = Math.floor(Math.random() * (256));
              var green = Math.floor(Math.random() * (256));
              var blue = Math.floor(Math.random() * (256));
              colors.push('rgb(' + red + ', ' + green + ', ' + blue + ')');
            }
            var wordfreqoptions = {};

            // Word frequencies
            Chart.defaults.global.defaultFontColor = 'white';
            Chart.defaults.global.defaultFontFamily = 'Bree Serif';
            var ctx = $("#barChart");
            var myBarChart = new Chart(ctx, {
              type: 'bar',
              data: {
                datasets: [{
                  label: "Word Frequencies",
                  data: wordfreqdata,
                  backgroundColor: colors
                }],

                labels: wordfreqlabels
              },
              options: {
                layout: {padding: 0},
                title: {display: true, text: "Top Word Frequencies", fontSize: 32, fontColor: '#FFF', fontFamily: 'Bree Serif', padding: 20},
                legend: {display: false, labels: {fontColor: '#FFF', fontFamily: 'Bree Serif', fontSize: 16}},
              scales: {
                yAxes: [{
                  ticks: {
                    beginAtZero: true
                  }
                }]
              }}
            });

            // Sentiment
            get_and_load_sentiment(sentiment_params);
          }
      );
      


</script>

  </body>
</html>