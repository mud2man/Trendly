<!doctype html>
<html lang="en">
  <head>
    <title>Trendly</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="assets/main.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Bree+Serif|Pacifico" rel="stylesheet">

    <!-- Codebird -->
    <script type="text/javascript" src="assets/codebird.js"></script>
  </head>
  <body>

    <div class="container">
      <div class="row">
        <div class="col-lg-2 col-md-12">
          <div class='text-center title-small brand'>
            Trendly
          </div>
        </div>
        <div class='col-lg-10 col-md-12'>
          <br />
          <form action="results.html">
            <div class="form-group">
              <input type="text" class="form-control text-center" id="queryInput-results"  name='q' placeholder="What would you like to know about?">
            </div>
          </form>
        </div>
      </div>
      <br />
      <nav class="nav nav-pills nav-fill">
        <a class="nav-item nav-link active" href="#">Sentiment</a>
        <a class="nav-item nav-link" href="#">Geography</a>
        <a class="nav-item nav-link" href="#">Charts</a>
        <a class="nav-item nav-link" href="#">Something Else</a>
      </nav>
      <div class="row">
        <div id="tweets">
          <!-- tweets go here -->
        </div>
        <div class="col-md-3">
        </div>
        <div class="col-md-6">
        <canvas id="myChart" width="400" height="400"></canvas>
        </div>
        <div class="col-md-3">
        </div>
      </div>
    </div>

    



    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.2.1.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ" crossorigin="anonymous"></script>

    <!-- Twitter stuff -->
    <script sync src="https://platform.twitter.com/widgets.js"></script>

    <script sync src="assets/chart.min.js"></script>


    <!-- More Codebird -->
    <script type="text/javascript">
      // https://www.sitepoint.com/url-parameters-jquery/
      $.urlParam = function(name){
        var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
        return results[1] || 0;
      }
      var query = $.urlParam("q");
      $('#queryInput-results').val(decodeURIComponent($.urlParam("q").replace(/\+/, " ")));
      var cb = new Codebird;
      cb.setConsumerKey("nDuDRuXVkv3N3GrJiTXm5cXtH", "nnqF5HGuyOURRe2fkcUZpVMTwdGS5xecfQIZvDr5GM2is8PsPr");
      var params = {
        q: query,
        //geocode: "40.808127,-73.965864,5mi",
        count: 100,
        lang: 'en',
        tweet_mode: 'extended',
        result_type: 'mixed'
      };
      cb.__call(
          "search_tweets",
          params,
          function (reply) {
            console.log(reply);
            var to_get = [];
            var sentiment_params = {};
            sentiment_params["documents"] = [];
            reply["statuses"].forEach(function(e) {
              to_get.push({id: e["id_str"], user: e["user"]["screen_name"]});
              sentiment_params["documents"].push({id: e["id_str"], text: e["full_text"],
              language: "en" 
              //,query: decodeURIComponent(query.replace(/\+/, " "))
            });
            });
            // for (var i = 0; i < to_get.length; ++i) {
            //   e = to_get[i];
            //   $('#tweets').append('<div id="tweet' + e['id'] + '"></div>');
            //   var tweet = document.getElementById("tweet" + e['id']);
            //   var id = e['id'];

            //   twttr.widgets.createTweet(
            //     id, tweet, 
            //     {
            //       conversation : 'none',    // or all
            //       cards        : 'hidden',  // or visible 
            //       linkColor:     '#f9953e',
            //       theme        : 'light',    // or dark
            //       width: 400
            //     })
            //   .then (function (el) {
            //     //
            //   });
            // }
            $.ajax({
              url: 'https://cors-anywhere.herokuapp.com/https://eastus.api.cognitive.microsoft.com/text/analytics/v2.0/sentiment',
              method: 'post',
              data: JSON.stringify(sentiment_params),
              headers: {
                'Ocp-Apim-Subscription-Key': '9d796f57b3da4b5084913fbd1394cdb4',
                'Content-Type': 'application/json',
                'Accept': 'application/json'
              },
              success: function(reply2){
                var num_pos = 0;
                var num_neg = 0;
                var num_neutral = 0;
                console.log(reply2)
                reply2['documents'].forEach(function(e) {
                  if (e['score'] < 0.4) {
                    num_neg += 1;
                  } else if (e['score'] >= 0.4 && e['score'] <= 0.6) {
                    num_neutral += 1;
                  } else {
                    num_pos += 1;
                  }
                });
                var ctx = $("#myChart");
                var data = {
                  datasets: [{
                      label: "Analysis Results",
                      data: [num_neg, num_neutral, num_pos],
                      backgroundColor:["rgb(255, 99, 132)","rgb(54, 162, 235)","rgb(0, 255, 0)"]
                  }],

                  // These labels appear in the legend and in the tooltips when hovering different arcs
                  labels: [
                      'Negative',
                      'Neutral',
                      'Positive'
                  ]
              };
                var myPieChart = new Chart(ctx,{
                  type: 'doughnut',
                  data: data,
                  options: {title: {display: true, text: "Analysis Results", fontSize: 32, fontColor: '#FFF', fontFamily: 'Bree Serif'}, legend: {labels: {fontColor: '#FFF', fontFamily: 'Bree Serif', fontSize: 16}}}
                });
              }});
          }
      );
      


</script>

  </body>
</html>